server {
  listen 80;
  server_name _;

  # Always serve whatever exists on disk under /hls/
  location /hls/ {
    alias /hls/;

    add_header Access-Control-Allow-Origin "*" always;

    # Public playlist gets a tiny cache to reduce client polling bursts
    location ~* ^/hls/[^/]+/index\.m3u8$ {
      types { application/vnd.apple.mpegurl m3u8; }
      add_header Cache-Control "public, max-age=1, must-revalidate" always;
      add_header Expires "0" always;
      add_header Access-Control-Allow-Origin "*" always;
    }

    # Allow short caching for variant playlists (live/offline) to reduce churn
    location ~* \.m3u8$ {
      types { application/vnd.apple.mpegurl m3u8; }
      add_header Cache-Control "public, max-age=2" always;
      add_header Expires "0" always;
      add_header Access-Control-Allow-Origin "*" always;
    }

    # Segments can be short cached
    location ~* \.ts$ {
      types { video/mp2t ts; }
      add_header Cache-Control "public, max-age=30" always;
      add_header Access-Control-Allow-Origin "*" always;
    }
  }

  # (Optional) health
  location = /healthz {
    return 200 "ok\n";
  }
}
